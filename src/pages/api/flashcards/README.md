# Flashcards API Endpoints

## POST /api/flashcards/generate-proposals

Generates flashcard proposals from source text using AI (OpenRouter).

### Request

**Method:** `POST`  
**Content-Type:** `application/json`  
**Authentication:** Required (Supabase Bearer token in Authorization header)

#### Request Body

```json
{
  "source_text": "Text content between 1000-10000 characters..."
}
```

#### Parameters

| Field         | Type   | Required | Description                                              |
| ------------- | ------ | -------- | -------------------------------------------------------- |
| `source_text` | string | Yes      | Source text for generating flashcards (1000-10000 chars) |

### Response

#### Success Response (200)

```json
{
  "generation_id": "uuid-string",
  "generated_count": 3,
  "flashcards_proposals": [
    {
      "front": "Question text",
      "back": "Answer text",
      "source": "ai_generated"
    }
  ]
}
```

#### Error Responses

| Status | Error                 | Description                             |
| ------ | --------------------- | --------------------------------------- |
| 400    | Bad Request           | Invalid JSON or validation errors       |
| 401    | Unauthorized          | Missing or invalid authentication       |
| 409    | Conflict              | Identical request made within last hour |
| 429    | Too Many Requests     | Rate limit exceeded                     |
| 502    | Bad Gateway           | External AI service unavailable         |
| 500    | Internal Server Error | Unexpected server error                 |

### Example Usage

```bash
# Valid request
curl -X POST "http://localhost:3000/api/flashcards/generate-proposals" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SUPABASE_JWT_TOKEN" \
  -d '{
    "source_text": "Your long text content here (minimum 1000 characters)..."
  }'
```

**Note:** The JWT token should be obtained from Supabase auth (e.g., `supabase.auth.getSession().data.session.access_token`).

### Validation Rules

- `source_text` must be between 1000-10000 characters
- Authentication via Supabase Bearer token in Authorization header required
- Duplicate requests (same user + text hash) blocked for 1 hour
- Text is automatically trimmed of leading/trailing whitespace

### Error Examples

#### Validation Error (400)

```json
{
  "error": "Bad Request",
  "message": "Invalid input data",
  "details": [
    {
      "field": "source_text",
      "message": "Source text must be at least 1000 characters long"
    }
  ]
}
```

#### Duplicate Request Error (409)

```json
{
  "error": "Conflict",
  "message": "Identical request was already generated within the last hour"
}
```

### Database Impact

The endpoint creates records in:

- `generation_sessions` - Session tracking and deduplication
- `generation_errors` - Error logging (when errors occur)

Note: No flashcards are saved to database - this endpoint only returns preview proposals.

---

## POST /api/flashcards/save-generated-flashcards

Saves selected (and optionally edited) flashcards generated by the AI in a previous session.

### Request

**Method:** `POST`  
**Content-Type:** `application/json`  
**Authentication:** Required (Supabase Bearer token in Authorization header)

#### Request Body

```json
{
  "generation_id": "uuid-string",
  "flashcards": [
    {
      "front": "Question text",
      "back": "Answer text",
      "source": "ai_generated"
    },
    {
      "front": "Edited question",
      "back": "Edited answer",
      "source": "ai_edited"
    }
  ]
}
```

#### Parameters

| Field                 | Type   | Required | Description                                 |
| --------------------- | ------ | -------- | ------------------------------------------- |
| `generation_id`       | string | Yes      | Generation session id (UUID)                |
| `flashcards`          | array  | Yes      | List of selected flashcards to save (min 1) |
| `flashcards[].front`  | string | Yes      | Front text (1-250 chars)                    |
| `flashcards[].back`   | string | Yes      | Back text (1-500 chars)                     |
| `flashcards[].source` | enum   | Yes      | `ai_generated` or `ai_edited`               |

### Response

#### Success Response (201)

```json
{
  "flashcards": [
    {
      "id": "uuid-string",
      "front": "Question text",
      "back": "Answer text",
      "source": "ai_generated",
      "created_at": "2026-01-18T10:00:00.000Z",
      "updated_at": "2026-01-18T10:00:00.000Z"
    }
  ]
}
```

#### Error Responses

| Status | Error                 | Description                               |
| ------ | --------------------- | ----------------------------------------- |
| 400    | Bad Request           | Invalid JSON or validation errors         |
| 401    | Unauthorized          | Missing or invalid authentication         |
| 404    | Not Found             | Generation session not found or not owned |
| 500    | Internal Server Error | Unexpected server error                   |

### Example Usage

```bash
# Valid request
curl -X POST "http://localhost:3000/api/flashcards/save-generated-flashcards" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SUPABASE_JWT_TOKEN" \
  -d '{
    "generation_id": "uuid-string",
    "flashcards": [
      {
        "front": "Question text",
        "back": "Answer text",
        "source": "ai_generated"
      }
    ]
  }'
```

### Validation Rules

- `generation_id` must be a valid UUID
- `flashcards` must contain at least 1 item
- `front` max length 250, `back` max length 500
- `source` must be `ai_generated` or `ai_edited`
- Total accepted count cannot exceed `generated_count` from the session

### Database Impact

The endpoint writes to:

- `flashcards` - inserts saved flashcards
- `generation_sessions` - updates accepted counts
